generator client {
  provider = "prisma-client"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Composition {
  id           String   @id @default(cuid())
  query        String   @db.Text
  queryNorm    String   @map("query_norm")
  name         String
  category     String
  description  String?  @db.Text
  rootData     Json     @map("root_data")
  sourcesData  Json     @map("sources_data")
  confidence   String
  viewCount    Int      @default(0) @map("view_count")
  shareCount   Int      @default(0) @map("share_count")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  researchedAt DateTime @map("researched_at")
  shares       Share[]

  @@index([queryNorm])
  @@index([category])
  @@map("compositions")
}

model Share {
  id            String      @id @default(cuid())
  shortCode     String      @unique @map("short_code")
  compositionId String      @map("composition_id")
  composition   Composition @relation(fields: [compositionId], references: [id], onDelete: Cascade)
  depthLevel    Int         @default(4) @map("depth_level")
  viewMode      String      @default("exploded") @map("view_mode")
  viewCount     Int         @default(0) @map("view_count")
  createdAt     DateTime    @default(now()) @map("created_at")

  @@index([shortCode])
  @@map("shares")
}

// ============================================
// Chat Models
// ============================================

model Conversation {
  id            String    @id @default(cuid())
  compositionId String    @map("composition_id")
  sessionId     String?   @map("session_id") // Anonymous session tracking
  userId        String?   @map("user_id") // Optional authenticated user
  messages      Message[]
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([compositionId])
  @@index([sessionId])
  @@index([userId])
  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String       @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String       // 'user' | 'assistant' | 'system'
  content        String       @db.Text
  nodeReferences Json?        @map("node_references") // Array of referenced node IDs
  tokens         Int?         // Token count for analytics
  createdAt      DateTime     @default(now()) @map("created_at")

  @@index([conversationId])
  @@map("messages")
}

model PopularQA {
  id            String   @id @default(cuid())
  compositionId String   @map("composition_id")
  question      String   @db.Text
  answer        String   @db.Text
  askCount      Int      @default(1) @map("ask_count")
  helpfulCount  Int      @default(0) @map("helpful_count")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([compositionId, question])
  @@index([compositionId])
  @@index([askCount])
  @@map("popular_qa")
}
